# Copyright 2016 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description     "Start servod based on config files"
author          "chromium-os-dev@chromium.org"

start on started system-services

pre-start script
  # If we have an existing config file, move it to the new style (config_$PORT).
  OLD_CONFIG_FILE=/var/lib/servod/config
  PORT=9999

  if [ -f $OLD_CONFIG_FILE ]; then
    mv $OLD_CONFIG_FILE $OLD_CONFIG_FILE_$PORT
  fi
end script

script
  # Config files are in the format config_$PORT, pull out the port and
  # pass it in to the upstart job.
  for PORT in $(ls /var/lib/servod/config_* | cut -d _ -f 2); do
    start servod PORT=$PORT
  done
end script
